<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis cursos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.0/cdn.min.js" defer></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
</head>
<body class="bg-gradient-to-b from-green-50 to-white text-gray-900 font-sans min-h-screen flex flex-col">

  <!-- Header -->
  <div id="header-container"></div>

  <main class="flex-grow max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 mt-8" x-data="cursosPage()">
    <h1 class="text-3xl sm:text-4xl font-extrabold mb-2 text-green-700">Mis cursos</h1>
    <p class="text-gray-700 mb-6">Vista general de los cursos en los que estás matriculado</p>

    <!-- Filtros -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div class="flex gap-2 flex-wrap">
        <select x-model="filtro" class="border border-gray-300 rounded px-3 py-2" @change="aplicarFiltros()">
          <option value="todos">Todos</option>
          <option value="activos">Activos</option>
          <option value="finalizados">Finalizados</option>
        </select>
        <input type="text" x-model="busqueda" placeholder="Buscar por nombre"
               class="border border-gray-300 rounded px-3 py-2 w-full md:w-64"
               @input="aplicarFiltros()" />
      </div>
      <select x-model="orden" class="border border-gray-300 rounded px-3 py-2" @change="aplicarFiltros()">
        <option value="nombre">Ordenar por nombre</option>
        <option value="ultimoAcceso">Ordenar por último acceso</option>
      </select>
    </div>

    <!-- Contenedor de cursos -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Mensaje de carga -->
      <template x-if="loading">
        <div class="col-span-full text-center py-12 animate-pulse">
          <i class="fas fa-spinner fa-spin text-4xl text-green-600 mb-4"></i>
          <p class="text-gray-600">Cargando sus cursos...</p>
        </div>
      </template>

      <!-- Mensaje si no hay cursos -->
      <template x-if="!loading && cursosFiltrados.length === 0">
        <div class="col-span-full flex flex-col items-center text-center py-12">
          <i class="fas fa-book-open text-5xl text-gray-400 mb-4"></i>
          <p class="font-semibold text-gray-900 mb-2">Usted no está matriculado en ningún curso</p>
          <p class="text-gray-700 max-w-md">Una vez que se inscriba en un curso, aparecerá aquí.</p>
        </div>
      </template>

      <!-- Cards de cursos -->
      <template x-for="curso in cursosFiltrados" :key="curso.id">
        <div class="bg-white rounded-xl shadow-md p-6 transform transition hover:-translate-y-1 hover:shadow-xl">
          <h3 class="text-xl font-semibold text-green-700 mb-2" x-text="curso.nombre"></h3>
          <p class="text-gray-600 mb-1" x-text="curso.profesor || 'Sin tutor asignado'"></p>
          <p class="text-sm italic text-gray-500 mb-3" x-text="curso.rol === 'profesor' ? 'Usted es el profesor' : 'Usted está matriculado'"></p>
          <a :href="`/views/curso.html?id=${curso.id}`"
             class="inline-block bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
            Ir al curso
          </a>
        </div>
      </template>
    </section>

    <!-- Error -->
    <template x-if="error">
      <div class="col-span-full text-center py-8 mt-6 bg-red-50 border border-red-200 rounded-lg">
        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-2"></i>
        <p class="font-semibold text-red-600 mb-2">Error al cargar los cursos</p>
        <p class="text-sm text-red-500 mb-4" x-text="error"></p>
        <button @click="cargarCursos()"
                class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-6 rounded transition">
          <i class="fas fa-sync-alt mr-2"></i> Reintentar
        </button>
      </div>
    </template>

  </main>

<script>
function cursosPage() {
  return {
    todosLosCursos: [],
    cursosFiltrados: [],
    busqueda: '',
    filtro: 'todos',
    orden: 'nombre',
    loading: true,
    error: '',
    cargarCursos() {
      this.loading = true;
      this.error = '';
      fetch('/api/miscursos', { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
          this.todosLosCursos = Array.isArray(data.data) ? data.data : [];
          this.aplicarFiltros();
          this.loading = false;
        })
        .catch(e => {
          console.error(e);
          this.loading = false;
          this.error = 'No se pudo conectar al servidor. Intente nuevamente.';
        });
    },
    aplicarFiltros() {
      let lista = this.todosLosCursos.filter(curso =>
        curso.nombre.toLowerCase().includes(this.busqueda.toLowerCase())
      );
      if (this.filtro === 'activos') lista = lista.filter(c => c.activo);
      if (this.filtro === 'finalizados') lista = lista.filter(c => !c.activo);
      if (this.orden === 'nombre') lista.sort((a,b) => a.nombre.localeCompare(b.nombre));
      if (this.orden === 'ultimoAcceso') lista.sort((a,b) => new Date(b.ultimoAcceso) - new Date(a.ultimoAcceso));
      this.cursosFiltrados = lista;
    },
    init() {
      this.cargarCursos();
    }
  }
}
</script>

<script>
  // Cargar header
  fetch('/views/header.html')
    .then(res => res.text())
    .then(html => {
      const container = document.getElementById('header-container');
      container.innerHTML = html;
      container.querySelectorAll('script').forEach(oldScript => {
        const newScript = document.createElement('script');
        if (oldScript.src) newScript.src = oldScript.src;
        else newScript.textContent = oldScript.textContent;
        document.body.appendChild(newScript);
        oldScript.remove();
      });
    });
</script>

</body>
</html>
