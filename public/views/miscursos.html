<!DOCTYPE html>
<html lang="es" x-data="mainPage()">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bienvenido Usuario</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.0/cdn.min.js" defer></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <style>
    .bg-green-900 { background-color: #00983d !important; }
    .border-green-800 { border-color: #00983d !important; }
    .peer-checked\:bg-green-600:checked { background-color: #00983d !important; }
    .peer-focus\:ring-green-300:focus { --tw-ring-color: #00983d !important; }
    .text-green-700 { color: #00983d !important; }
    .bg-green-200 { background-color: #c6f0cc !important; }
    a:hover { text-decoration: underline; text-decoration-thickness: 1px; }
  </style>
</head>
<body class="bg-white text-gray-900 font-sans min-h-screen flex flex-col">

  <!-- Header -->
  <div id="header-container" x-html="headerHtml" x-init="loadHeader()"></div>

  <!-- Bienvenida -->
  <main class="flex flex-col md:flex-row max-w-7xl mx-auto mt-6 px-4 sm:px-6 md:px-8 space-y-6 md:space-y-0 md:space-x-6">
    <section class="flex-1 rounded border border-gray-300 p-6 flex flex-col">
      <h1 class="text-3xl sm:text-4xl font-extrabold mb-6 text-green-700 opacity-0" 
          x-text="`¬°Bienvenido/a, ${userName}! üëã`" 
          x-transition.opacity.duration.700ms
          x-show="loaded"></h1>

      <article class="bg-gray-100 rounded border border-gray-300 p-6 flex-grow flex items-center justify-center">
        <img src="https://storage.googleapis.com/a1aa/image/e5493b0f-72c1-46a1-a99d-8b6600e36418.jpg" 
             alt="Logo General de Tutor√≠as" 
             class="h-16 w-auto mr-4">
        <p class="text-gray-700 text-lg font-medium">General de Tutor√≠as</p>
      </article>
    </section>

    <!-- Recientes -->
    <aside class="w-full md:w-80 rounded border border-gray-300 p-4">
      <h3 class="font-semibold mb-4 text-gray-900">Elementos accedidos recientemente</h3>
      <div class="border border-gray-200 rounded p-4 text-center text-gray-400">
        <img src="https://storage.googleapis.com/a1aa/image/cda9149f-76a1-4642-7cf2-9256e772d96b.jpg"
             alt="Icono elementos recientes"
             class="mx-auto mb-2 h-12 w-12">
        <p class="text-sm">Sin elementos recientes</p>
      </div>
    </aside>
  </main>

  <!-- Calendario -->
  <section class="max-w-7xl mx-auto mt-6 px-4 sm:px-6 md:px-8" x-show="loaded" x-transition.opacity>
    <div class="rounded border border-gray-300 p-6 max-w-4xl mx-auto">
      <div class="flex justify-between items-center mb-4">
        <button @click="prevMonth" class="text-green-700 hover:underline text-sm">&larr; Anterior</button>
        <h2 class="text-xl font-semibold text-gray-900" x-text="monthYear"></h2>
        <button @click="nextMonth" class="text-green-700 hover:underline text-sm">Siguiente &rarr;</button>
      </div>
      <div class="w-full overflow-auto">
        <table class="w-full border-collapse border border-gray-300 text-center">
          <thead class="bg-green-900 text-white">
            <tr>
              <th class="border border-gray-300 px-2 py-1 text-sm">Dom</th>
              <th class="border border-gray-300 px-2 py-1 text-sm">Lun</th>
              <th class="border border-gray-300 px-2 py-1 text-sm">Mar</th>
              <th class="border border-gray-300 px-2 py-1 text-sm">Mi√©</th>
              <th class="border border-gray-300 px-2 py-1 text-sm">Jue</th>
              <th class="border border-gray-300 px-2 py-1 text-sm">Vie</th>
              <th class="border border-gray-300 px-2 py-1 text-sm">S√°b</th>
            </tr>
          </thead>
          <tbody id="calendar-body" class="text-sm text-gray-900">
            <template x-for="week in calendar" :key="week[0]">
              <tr>
                <template x-for="day in week" :key="day?.date">
                  <td class="border border-gray-300 px-2 py-1 h-10 align-top"
                      :class="{'bg-green-200 font-bold': day.today}"
                      @click="selectDay(day)">
                    <span x-text="day?.day || ''"></span>
                  </td>
                </template>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </section>

<script>
function mainPage() {
  return {
    userName: 'USUARIO',
    headerHtml: '',
    loaded: false,
    calendar: [],
    monthYear: '',
    currentDate: new Date(),

    loadHeader() {
      fetch('/views/header.html')
        .then(res => res.text())
        .then(html => {
          this.headerHtml = html;
          this.loadUser();
        });
    },

    loadUser() {
      fetch('/api/perfil', { credentials: 'include' })
        .then(res => { if(!res.ok) throw new Error('No autenticado'); return res.json(); })
        .then(p => {
          const nombre = p?.nombre?.trim() || 'USUARIO';
          this.userName = nombre;
          this.loaded = true;
          this.generateCalendar(this.currentDate);
        })
        .catch(() => {
          this.userName = 'USUARIO';
          this.loaded = true;
          this.generateCalendar(this.currentDate);
        });
    },

    getInitials(fullName) {
      if (!fullName) return 'US';
      const stop = new Set(['de','del','la','las','los','y','da','do','dos','das']);
      const clean = fullName.normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/\s+/g,' ').trim();
      const words = clean.split(' ').filter(w => !stop.has(w.toLowerCase()));
      if(words.length===0) return 'US';
      const first = words[0].split('-')[0];
      const last = (words.length>1 ? words[words.length-1] : words[0]).split('-')[0];
      return (first[0]+last[0]).toUpperCase();
    },

    generateCalendar(date) {
      const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
      const year = date.getFullYear();
      const month = date.getMonth();
      this.monthYear = `${months[month]} ${year}`;
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month+1, 0).getDate();
      const today = new Date();

      let dayCount = 1;
      const weeks = [];
      for(let w=0; w<6; w++){
        const week = [];
        for(let d=0; d<7; d++){
          if((w===0 && d<firstDay) || dayCount>daysInMonth) week.push({});
          else {
            week.push({
              day: dayCount,
              date: new Date(year, month, dayCount),
              today: dayCount===today.getDate() && month===today.getMonth() && year===today.getFullYear()
            });
            dayCount++;
          }
        }
        weeks.push(week);
        if(dayCount>daysInMonth) break;
      }
      this.calendar = weeks;
    },

    prevMonth() { this.currentDate.setMonth(this.currentDate.getMonth()-1); this.generateCalendar(this.currentDate); },
    nextMonth() { this.currentDate.setMonth(this.currentDate.getMonth()+1); this.generateCalendar(this.currentDate); },
    selectDay(day) { if(day.day) alert(`D√≠a seleccionado: ${day.day}/${day.date.getMonth()+1}/${day.date.getFullYear()}`); }
  }
}
</script>

</body>
</html>
