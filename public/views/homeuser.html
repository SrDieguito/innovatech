<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bienvenido Usuario</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.0/cdn.min.js" defer></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
</head>
<body class="bg-gradient-to-b from-green-50 to-white text-gray-900 font-sans min-h-screen flex flex-col">

  <!-- Header -->
  <div id="header-container"></div>

  <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 md:px-8 mt-6" x-data="homePage()">
    <!-- Bienvenida -->
    <h1 class="text-3xl sm:text-4xl font-extrabold mb-6 text-green-700">
      Â¡Bienvenido/a, <span x-text="userName">USUARIO</span>! ðŸ‘‹
    </h1>

    <!-- Calendario -->
    <section class="rounded border border-gray-300 p-6">
      <div class="flex justify-between items-center mb-4">
        <button @click="prevMonth()" class="text-green-700 hover:underline text-sm">&larr; Anterior</button>
        <h2 class="text-xl font-semibold text-gray-900" x-text="monthYear"></h2>
        <button @click="nextMonth()" class="text-green-700 hover:underline text-sm">Siguiente &rarr;</button>
      </div>
      <div class="w-full overflow-auto">
        <table class="w-full border-collapse border border-gray-300 text-center">
          <thead class="bg-green-900 text-white">
            <tr>
              <th class="border border-gray-300 px-2 py-1 text-sm">Dom</th>
              <th class="border border-gray-300 px-2 py-1 text-sm">Lun</th>
              <th class="border border-gray-300 px-2 py-1 text-sm">Mar</th>
              <th class="border border-gray-300 px-2 py-1 text-sm">MiÃ©</th>
              <th class="border border-gray-300 px-2 py-1 text-sm">Jue</th>
              <th class="border border-gray-300 px-2 py-1 text-sm">Vie</th>
              <th class="border border-gray-300 px-2 py-1 text-sm">SÃ¡b</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="week in calendar" :key="week[0].date">
              <tr>
                <template x-for="day in week" :key="day.date">
                  <td class="border border-gray-300 px-2 py-1 h-10 align-top"
                      :class="{'bg-green-200 font-bold': day.today}"
                      x-text="day.number">
                  </td>
                </template>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    function homePage() {
      return {
        userName: 'USUARIO',
        currentDate: new Date(),
        monthYear: '',
        calendar: [],

        init() {
          // Traer nombre del usuario
          fetch('/api/perfil', { credentials: 'include' })
            .then(res => { if(!res.ok) throw new Error('No autenticado'); return res.json(); })
            .then(p => {
              this.userName = (p?.nombre || 'USUARIO').trim();
              this.generateCalendar(this.currentDate);
            })
            .catch(() => {
              this.userName = 'USUARIO';
              this.generateCalendar(this.currentDate);
            });
        },

        generateCalendar(date) {
          const year = date.getFullYear();
          const month = date.getMonth();
          this.monthYear = `${["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][month]} ${year}`;

          const firstDay = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const today = new Date();

          let weeks = [];
          let dayCount = 1;

          for (let w = 0; w < 6; w++) {
            let week = [];
            for (let d = 0; d < 7; d++) {
              if ((w === 0 && d < firstDay) || dayCount > daysInMonth) {
                week.push({ number: '', date: null, today: false });
              } else {
                week.push({
                  number: dayCount,
                  date: new Date(year, month, dayCount),
                  today: dayCount === today.getDate() && month === today.getMonth() && year === today.getFullYear()
                });
                dayCount++;
              }
            }
            weeks.push(week);
            if(dayCount > daysInMonth) break;
          }
          this.calendar = weeks;
        },

        prevMonth() {
          this.currentDate.setMonth(this.currentDate.getMonth() - 1);
          this.generateCalendar(this.currentDate);
        },

        nextMonth() {
          this.currentDate.setMonth(this.currentDate.getMonth() + 1);
          this.generateCalendar(this.currentDate);
        }
      }
    }

    // Cargar header
    fetch('/views/header.html')
      .then(res => res.text())
      .then(html => {
        const container = document.getElementById('header-container');
        container.innerHTML = html;
        container.querySelectorAll('script').forEach(oldScript => {
          const newScript = document.createElement('script');
          if(oldScript.src) newScript.src = oldScript.src;
          else newScript.textContent = oldScript.textContent;
          document.body.appendChild(newScript);
          oldScript.remove();
        });
      });
  </script>

</body>
</html>
