<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Curso</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.0/cdn.min.js" defer></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
</head>
<body class="bg-gradient-to-b from-green-50 to-white text-gray-900 min-h-screen flex flex-col">

<!-- Header -->
<div id="header-container" class="shadow-lg bg-white"></div>

<main class="flex-grow px-6 py-8 max-w-7xl mx-auto" x-data="{ tab: 'curso', subTab: 'presentacion' }">

  <!-- Encabezado del curso -->
  <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 text-center">
    <h1 id="nombre-curso" class="text-4xl font-extrabold text-green-700 mb-2">Nombre del Curso</h1>
    <p id="nombre-tutor" class="text-gray-600 text-lg flex items-center justify-center gap-2"><i class="fas fa-chalkboard-teacher"></i> Tutor: Nombre del Tutor</p>
  </div>

  <!-- Pestañas principales -->
  <div class="flex justify-center gap-4 mb-6">
    <button @click="tab='curso'" :class="tab==='curso' ? 'bg-green-100 text-green-700 font-semibold' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2 rounded-full transition">Curso</button>
    <button @click="tab='participantes'" :class="tab==='participantes' ? 'bg-green-100 text-green-700 font-semibold' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2 rounded-full transition">Participantes</button>
    <button @click="tab='calificaciones'" :class="tab==='calificaciones' ? 'bg-green-100 text-green-700 font-semibold' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2 rounded-full transition">Calificaciones</button>
  </div>

  <!-- Contenido -->
  <div x-show="tab==='curso'">

    <!-- Subpestañas -->
    <div class="flex flex-wrap justify-center gap-2 mb-6">
      <template x-for="sub in ['presentacion','cronograma','materiales','actividades','examenes','encuesta']">
        <button @click="subTab=sub" :class="subTab===sub ? 'bg-green-200 text-green-800 font-medium' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-4 py-1 rounded-full text-sm transition capitalize" x-text="sub"></button>
      </template>
    </div>

    <!-- Subcontenido -->
    <div id="presentacion-holder"></div>


    <div x-show="subTab==='cronograma'" x-transition class="bg-white rounded-2xl shadow-md p-6 mb-6">
      <h2 class="text-2xl font-semibold mb-3"><i class="fas fa-calendar-alt mr-2"></i> Cronograma</h2>
      <p class="text-gray-700">Contenido del cronograma...</p>
    </div>

    <div x-show="subTab==='materiales'" x-transition class="bg-white rounded-2xl shadow-md p-6 mb-6">
      <h2 class="text-2xl font-semibold mb-3"><i class="fas fa-folder-open mr-2"></i> Materiales de aprendizaje</h2>
      <p class="text-gray-700">Materiales aquí...</p>
    </div>

    <div x-show="subTab==='actividades'" x-transition class="bg-white rounded-2xl shadow-md p-6 mb-6">
      <h2 class="text-2xl font-semibold mb-3"><i class="fas fa-tasks mr-2"></i> Actividades de aprendizaje</h2>
      <div id="actividades-holder" class="mt-2 text-left"></div>
    </div>

    <div x-show="subTab==='examenes'" x-transition class="bg-white rounded-2xl shadow-md p-6 mb-6">
      <h2 class="text-2xl font-semibold mb-3"><i class="fas fa-file-alt mr-2"></i> Exámenes</h2>
      <p class="text-gray-700">Exámenes aquí...</p>
    </div>

    <div x-show="subTab==='encuesta'" x-transition class="bg-white rounded-2xl shadow-md p-6 mb-6">
      <h2 class="text-2xl font-semibold mb-3"><i class="fas fa-poll mr-2"></i> Encuesta</h2>
      <p class="text-gray-700">Encuesta final...</p>
    </div>

  </div>

  <!-- Participantes -->
<div x-show="tab==='participantes'" x-transition class="bg-white rounded-2xl shadow-md p-6 mb-6">
  <h2 class="text-2xl font-semibold mb-3"><i class="fas fa-users mr-2"></i> Participantes</h2>
  <div id="participantes-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
    <p id="cargando-participantes" class="text-gray-500 col-span-full">Cargando participantes...</p>
  </div>
</div>



  <!-- Calificaciones -->
  <div x-show="tab==='calificaciones'" x-transition class="bg-white rounded-2xl shadow-md p-6 mb-6">
    <h2 class="text-2xl font-semibold mb-3"><i class="fas fa-graduation-cap mr-2"></i> Calificaciones</h2>
    <p class="text-gray-700">Calificaciones del curso...</p>
  </div>

</main>

<script src="/js/task.js"></script>
<script>
  // === Cargar Header ===
  fetch('/views/header.html')
    .then(res => res.text())
    .then(html => {
      const container = document.getElementById('header-container');
      container.innerHTML = html;

      // Ejecutar scripts que vengan dentro del header
      const scripts = container.querySelectorAll('script');
      scripts.forEach(oldScript => {
        const newScript = document.createElement('script');
        if (oldScript.src) {
          newScript.src = oldScript.src;
        } else {
          newScript.textContent = oldScript.textContent;
        }
        document.body.appendChild(newScript);
        oldScript.remove();
      });
    });

  // === Obtener ID de curso desde la URL ===
  const params = new URLSearchParams(window.location.search);
  const cursoId = params.get("id") || params.get("curso_id") || params.get("courseId");

  if (!cursoId) {
    alert("No se proporcionó ID de curso");
    location.href = "/mis-cursos.html";
  }

  // === Función para cargar la pestaña Presentación dinámicamente ===
  async function cargarPresentacion(curso, esProfesor, cursoId) {
    const holder = document.getElementById('presentacion-holder');
    if (!holder || holder.dataset.loaded) return; // evitar doble carga

    const res = await fetch('/partials/curso/presentacion.html');
    holder.innerHTML = await res.text();

    // Inicializar lógica propia de la pestaña Presentación
    if (window.PresentacionPage) {
      window.PresentacionPage.init(curso, esProfesor, cursoId);
    }

    holder.dataset.loaded = "1";
  }

  // === Cargar actividades (fragmento + inicialización) ===
  async function cargarActividades(esProfesor) {
    const holder = document.getElementById('actividades-holder');
    if (!holder || holder.dataset.loaded) return;

    const res = await fetch('/partials/task.html');
    holder.innerHTML = await res.text();

    const root = holder.querySelector('#tasks-root');
    root.dataset.role = esProfesor ? 'profesor' : 'estudiante';
    root.dataset.courseId = cursoId;

    if (window.TasksPage) {
      window.TasksPage.init();
    }

    // Eliminar botones de acción
    setTimeout(() => {
      holder.querySelectorAll('[data-field="actions"], [data-field="student-actions"]').forEach(el => el.remove());
      const btnNuevaTarea = holder.querySelector('#btnNuevaTarea');
      if (btnNuevaTarea) btnNuevaTarea.remove();

      holder.querySelectorAll('button').forEach(boton => {
        const texto = boton.textContent.toLowerCase();
        if (
          texto.includes('entregar') || texto.includes('editar') || texto.includes('eliminar') ||
          texto.includes('actualizar') || texto.includes('calificar') || texto.includes('completar') ||
          texto.includes('ver entrega')
        ) {
          boton.remove();
        }
      });
    }, 100);

    holder.dataset.loaded = "1";
  }

  // === Cargar datos principales del curso ===
  fetch(`/api/cursos?action=obtener-detalle&id=${cursoId}`)
    .then(res => {
      if (!res.ok) {
        throw new Error(`Error al cargar el curso: ${res.status} ${res.statusText}`);
      }
      return res.json();
    })
    .then(curso => {
      if (!curso) throw new Error('No se pudo cargar la información del curso');

      // Asignar datos básicos
      document.getElementById('nombre-curso').textContent = curso.nombre || 'Curso sin nombre';
      document.getElementById('nombre-tutor').textContent = `Tutor: ${curso.profesor || 'No asignado'}`;

      // === Cargar perfil de usuario actual ===
      return fetch('/api/perfil')
        .then(res => {
          if (!res.ok) {
            throw new Error(`Error al cargar el perfil de usuario: ${res.status} ${res.statusText}`);
          }
          return res.json();
        })
        .then(usuario => {
          if (!usuario || !usuario.id) throw new Error('No se pudo cargar la información del usuario');

          const esProfesor =
            usuario.id === curso.profesor_id ||
            usuario.rol === 'profesor' ||
            usuario.rol === 'admin';

          // === Verificar subpestaña actual de Alpine ===
          const subTab = document.querySelector('main').__x.$data.subTab;

          // Cargar presentación si es la pestaña activa por defecto
          if (subTab === 'presentacion') {
            cargarPresentacion(curso, esProfesor, cursoId);
          }

          // Detectar cambios entre subpestañas
          document.addEventListener('click', (e) => {
            const btn = e.target.closest('[x-text]');
            if (btn) {
              const sub = btn.textContent.trim().toLowerCase();
              if (sub === 'presentacion') {
                cargarPresentacion(curso, esProfesor, cursoId);
              }
            }
          });

          // === Cargar otras secciones ===
          cargarActividades(esProfesor);
          cargarParticipantes(cursoId);
        });
    })
    .catch(error => {
      console.error('Error:', error);
      alert(error.message || 'Ocurrió un error al cargar el curso');
      window.location.href = '/mis-cursos.html';
    });

  // === Función para cargar participantes ===
  async function cargarParticipantes(cursoId) {
    const listContainer = document.getElementById('participantes-list');
    const cargando = document.getElementById('cargando-participantes');
    try {
      const res = await fetch(`/api/participantes?id=${cursoId}`, { credentials: 'include' });
      if (!res.ok) throw new Error('Error al cargar participantes');

      const data = await res.json();
      cargando.remove();

      if (Array.isArray(data) && data.length > 0) {
        data.forEach(usuario => {
          const div = document.createElement('div');
          div.className = 'bg-green-50 rounded-lg p-3 flex items-center gap-3 hover:bg-green-100 transition';
          div.innerHTML = `
            <div class="w-10 h-10 rounded-full bg-green-200 flex items-center justify-center text-green-700 font-semibold">
              ${(usuario.nombre[0] || 'U').toUpperCase()}
            </div>
            <div>
              <p class="font-medium text-gray-700">${usuario.nombre}</p>
              <p class="text-gray-500 text-sm">${usuario.email || ''}</p>
            </div>
          `;
          listContainer.appendChild(div);
        });
      } else {
        listContainer.innerHTML = '<p class="text-gray-500 col-span-full">No hay participantes inscritos.</p>';
      }
    } catch (err) {
      console.error(err);
      listContainer.innerHTML = '<p class="text-red-500 col-span-full">Error al cargar los participantes.</p>';
    }
  }

  // === Navegación entre pestañas principales ===
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', e => {
      e.preventDefault();
      const selected = tab.dataset.tab;

      document.querySelectorAll('.tab').forEach(t => t.classList.remove('text-green-600', 'font-medium'));
      tab.classList.add('text-green-600', 'font-medium');

      document.querySelectorAll('.tab-content').forEach(section => {
        section.classList.add('hidden');
      });

      document.getElementById(selected).classList.remove('hidden');
    });
  });
</script>

</body>
</html>