<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Curso</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.0/cdn.min.js" defer></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
</head>
<body class="bg-gradient-to-b from-green-50 to-white text-gray-900 min-h-screen flex flex-col">

<!-- Header -->
<div id="header-container" class="shadow-lg bg-white"></div>

<main class="flex-grow px-6 py-8 max-w-7xl mx-auto" x-data="{ tab: 'curso', subTab: 'presentacion' }">

  <!-- Encabezado del curso -->
  <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 text-center">
    <h1 id="nombre-curso" class="text-4xl font-extrabold text-green-700 mb-2">Nombre del Curso</h1>
    <p id="nombre-tutor" class="text-gray-600 text-lg flex items-center justify-center gap-2"><i class="fas fa-chalkboard-teacher"></i> Tutor: Nombre del Tutor</p>
  </div>

  <!-- Pestañas principales -->
  <div class="flex justify-center gap-4 mb-6">
    <button @click="tab='curso'" :class="tab==='curso' ? 'bg-green-100 text-green-700 font-semibold' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2 rounded-full transition">Curso</button>
    <button @click="tab='participantes'" :class="tab==='participantes' ? 'bg-green-100 text-green-700 font-semibold' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2 rounded-full transition">Participantes</button>
    <button @click="tab='calificaciones'" :class="tab==='calificaciones' ? 'bg-green-100 text-green-700 font-semibold' : 'text-gray-600 hover:bg-gray-100'" class="px-5 py-2 rounded-full transition">Calificaciones</button>
  </div>

  <!-- Contenido -->
  <div x-show="tab==='curso'">

    <!-- Subpestañas -->
    <div class="flex flex-wrap justify-center gap-2 mb-6">
      <template x-for="sub in ['presentacion','cronograma','materiales','actividades','examenes','encuesta']">
        <button @click="subTab=sub" :class="subTab===sub ? 'bg-green-200 text-green-800 font-medium' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-4 py-1 rounded-full text-sm transition capitalize" x-text="sub"></button>
      </template>
    </div>

    <!-- Subcontenido -->
    <!-- Presentación (cargada dinámicamente) -->
    <div id="presentacion-container" x-show="subTab==='presentacion'" x-transition class="bg-white rounded-2xl shadow-md p-6 mb-6">
      <!-- El contenido se cargará aquí dinámicamente -->
    </div>

    <!-- Otras secciones (mantenidas estáticamente) -->
    <div x-show="subTab==='cronograma'" x-transition class="bg-white rounded-2xl shadow-md p-6 mb-6">
      <h2 class="text-2xl font-semibold mb-3"><i class="fas fa-calendar-alt mr-2"></i> Cronograma</h2>
      <p class="text-gray-700">Contenido del cronograma...</p>
    </div>
    <div x-show="subTab==='materiales'" x-transition class="bg-white rounded-2xl shadow-md p-6 mb-6">
      <h2 class="text-2xl font-semibold mb-3"><i class="fas fa-folder-open mr-2"></i> Materiales de aprendizaje</h2>
      <p class="text-gray-700">Materiales aquí...</p>
    </div>

    <div x-show="subTab==='actividades'" x-transition class="bg-white rounded-2xl shadow-md p-6 mb-6">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-2xl font-semibold"><i class="fas fa-tasks mr-2"></i> Actividades de aprendizaje</h2>
        <!-- Botón de crear tarea -->
        <button id="btn-crear-tarea" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center transition-colors">
          <i class="fas fa-plus mr-1"></i> Crear tarea
        </button>
      </div>
      <div id="actividades-holder" class="mt-2 text-left"></div>
    </div>

    <div x-show="subTab==='examenes'" x-transition class="bg-white rounded-2xl shadow-md p-6 mb-6">
      <h2 class="text-2xl font-semibold mb-3"><i class="fas fa-file-alt mr-2"></i> Exámenes</h2>
      <p class="text-gray-700">Exámenes aquí...</p>
{{ ... }}
    </div>

    <div x-show="subTab==='encuesta'" x-transition class="bg-white rounded-2xl shadow-md p-6 mb-6">
      <h2 class="text-2xl font-semibold mb-3"><i class="fas fa-poll mr-2"></i> Encuesta</h2>
      <p class="text-gray-700">Encuesta final...</p>
    </div>

  </div>

  <!-- Participantes -->
  <div x-show="tab==='participantes'" x-transition class="bg-white rounded-2xl shadow-md p-6 mb-6">
    <h2 class="text-2xl font-semibold mb-3"><i class="fas fa-users mr-2"></i> Participantes</h2>
    <div id="participantes-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
      <p id="cargando-participantes" class="text-gray-500 col-span-full">Cargando participantes...</p>
    </div>
  </div>

  <!-- Pestaña Calificaciones -->
<div x-show="tab==='calificaciones'" x-transition class="bg-white rounded-2xl shadow-md p-6 mb-6">
  <div class="max-w-4xl mx-auto">
    <div class="mb-4">
      <h2 class="text-2xl font-semibold mb-2 text-gray-800">
        <i class="fas fa-star mr-2"></i> Calificaciones
      </h2>
      <p class="text-sm text-gray-500">Calificaciones del curso por tarea.</p>
    </div>
    <div id="calificaciones-panel" class="space-y-4">
      <!-- Aquí se cargarán las calificaciones dinámicamente -->
    </div>
  </div>
</div>
</main>

<script src="/js/task.js"></script>
<script src="/js/recomendaciones.js"></script>
<script src="/js/curso-boton-crear.js" type="module"></script>
<script>
  // Variables globales
  let cursoId;
  let esProfesor = false;
  let usuarioActual;
  let cursoData;

  // Cargar header
  fetch('/views/header.html')
    .then(res => res.text())
    .then(html => {
      const container = document.getElementById('header-container');
      container.innerHTML = html;

      // Ejecutar scripts del header
      const scripts = container.querySelectorAll('script');
      scripts.forEach(oldScript => {
        const newScript = document.createElement('script');
        if (oldScript.src) {
          newScript.src = oldScript.src;
        } else {
          newScript.textContent = oldScript.textContent;
        }
        document.body.appendChild(newScript);
        oldScript.remove();
      });
    });

  // Obtener ID de curso de la URL
  const params = new URLSearchParams(window.location.search);
  cursoId = params.get("id") || params.get("curso_id") || params.get("courseId");

  if (!cursoId) {
    alert("No se proporcionó ID de curso");
    location.href = "/mis-cursos.html";
  }

  // Función para cargar la presentación
  async function cargarPresentacion() {
    const contenedor = document.getElementById('presentacion-container');
    
    try {
      // Cargar el partial correspondiente desde views/presentacion/
      const respuesta = await fetch('presentacion.html');
      if (!respuesta.ok) {
        throw new Error(`No se pudo cargar la presentación: ${respuesta.status}`);
      }
      
      const html = await respuesta.text();
      contenedor.innerHTML = html;
      
      // Inicializar la presentación
      inicializarPresentacion();
    } catch (error) {
      console.error('Error al cargar la presentación:', error);
      contenedor.innerHTML = `
        <div class="text-center py-4 text-red-500">
          <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
          <p>Error al cargar la presentación</p>
        </div>
      `;
    }
  }

  // Función para inicializar la sección de presentación
  function inicializarPresentacion() {
    // Actualizar la descripción del curso
    const presentacionTexto = document.getElementById('presentacion-texto');
    if (presentacionTexto && cursoData) {
      presentacionTexto.textContent = cursoData.descripcion || 'Sin descripción';
    }

    // Configurar el editor si es profesor
    if (esProfesor) {
      const editor = document.getElementById('presentacion-editor');
      if (editor) {
        editor.classList.remove('hidden');
        const descInput = document.getElementById('descripcion-input');
        if (descInput && cursoData) {
          descInput.value = cursoData.descripcion || '';
        }
      }
      
      // Configurar el evento de guardado
      const guardarBtn = document.getElementById('guardar-descripcion');
      if (guardarBtn) {
        guardarBtn.addEventListener('click', guardarDescripcion);
      }
    }
  }

  // Función para guardar la descripción del curso
  function guardarDescripcion() {
    const nuevaDescripcion = document.getElementById('descripcion-input').value;

    fetch(`/api/cursos?action=actualizar-descripcion`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        curso_id: cursoId,
        descripcion: nuevaDescripcion
      })
    })
      .then(res => res.json())
      .then(res => {
        if (res.success) {
          document.getElementById('presentacion-texto').textContent = nuevaDescripcion;
          alert('Descripción actualizada');
        } else {
          alert('Error al actualizar');
        }
      });
  }

  // === CARGAR ACTIVIDADES (fragmento + init) ===
  async function cargarActividades(esProfesor) {
    const holder = document.getElementById('actividades-holder');
    if (!holder || holder.dataset.loaded) return; // evita doble carga

    // Trae el fragmento /partials/tasks.html
    const res = await fetch('/partials/task.html');
    holder.innerHTML = await res.text();

    // Configura dataset para rol y curso
    const root = holder.querySelector('#tasks-root');
    root.dataset.role = esProfesor ? 'profesor' : 'estudiante';
    root.dataset.courseId = cursoId;

    // Inicializa la página de tareas
    if (window.TasksPage) {
      window.TasksPage.init();
    }

    // Eliminar TODOS los botones de acción inmediatamente después de la inicialización
    setTimeout(() => {
      // Eliminar botones de profesor
      const accionesProfesor = holder.querySelectorAll('[data-field="actions"]');
      accionesProfesor.forEach(accion => accion.remove());
      
      // Eliminar botones de estudiante
      const accionesEstudiante = holder.querySelectorAll('[data-field="student-actions"]');
      accionesEstudiante.forEach(accion => accion.remove());
      
      // Eliminar botón de nueva tarea
      const btnNuevaTarea = holder.querySelector('#btnNuevaTarea');
      if (btnNuevaTarea) btnNuevaTarea.remove();
      
      // Eliminar cualquier otro botón de acción que pueda existir
      const botonesAccion = holder.querySelectorAll('button');
      botonesAccion.forEach(boton => {
        const texto = boton.textContent.toLowerCase();
        if (texto.includes('entregar') || texto.includes('editar') || 
            texto.includes('eliminar') || texto.includes('actualizar') ||
            texto.includes('calificar') || texto.includes('completar') ||
            texto.includes('ver entrega')) {
          boton.remove();
        }
      });
    }, 100);

    holder.dataset.loaded = "1";
  }

  // Cargar datos del curso
  fetch(`/api/cursos?action=obtener-detalle&id=${cursoId}`)
    .then(res => {
      if (!res.ok) {
        throw new Error(`Error al cargar el curso: ${res.status} ${res.statusText}`);
      }
      return res.json();
    })
    .then(curso => {
      if (!curso) {
        throw new Error('No se pudo cargar la información del curso');
      }
      
      // Guardar datos del curso en variable global
      cursoData = curso;
      
      document.getElementById('nombre-curso').textContent = curso.nombre || 'Curso sin nombre';
      document.getElementById('nombre-tutor').textContent = `Tutor: ${curso.profesor || 'No asignado'}`;

      // Obtener usuario actual
      return fetch('/api/perfil')
        .then(res => {
          if (!res.ok) {
            throw new Error(`Error al cargar el perfil de usuario: ${res.status} ${res.statusText}`);
          }
          return res.json();
        })
        .then(usuario => {
          if (!usuario || !usuario.id) {
            throw new Error('No se pudo cargar la información del usuario');
          }
          usuarioActual = usuario;
          esProfesor = usuario.id === curso.profesor_id || usuario.rol === 'profesor' || usuario.rol === 'admin';
          
          // Cargar la presentación
          cargarPresentacion();
          
          // Cargar actividades
          cargarActividades(esProfesor);
          
          // Cargar participantes
          cargarParticipantes(cursoId);
        });
    })
    .catch(error => {
      console.error('Error:', error);
      alert(error.message || 'Ocurrió un error al cargar el curso');
      // Redirigir a la página de cursos si hay un error
      window.location.href = '/mis-cursos.html';
    });

  // Función para cargar participantes
  async function cargarParticipantes(cursoId){
    const listContainer = document.getElementById('participantes-list');
    const cargando = document.getElementById('cargando-participantes');
    try {
      const res = await fetch(`/api/participantes?id=${cursoId}`, { credentials:'include' });
      if(!res.ok) throw new Error('Error al cargar participantes');
      const data = await res.json();
      cargando.remove();
      if(Array.isArray(data) && data.length>0){
        data.forEach(usuario=>{
          const div = document.createElement('div');
          div.className='bg-green-50 rounded-lg p-3 flex items-center gap-3 hover:bg-green-100 transition';
          div.innerHTML=`
            <div class="w-10 h-10 rounded-full bg-green-200 flex items-center justify-center text-green-700 font-semibold">${(usuario.nombre[0]||'U').toUpperCase()}</div>
            <div>
              <p class="font-medium text-gray-700">${usuario.nombre}</p>
              <p class="text-gray-500 text-sm">${usuario.email||''}</p>
            </div>
          `;
          listContainer.appendChild(div);
        });
      } else {
        listContainer.innerHTML='<p class="text-gray-500 col-span-full">No hay participantes inscritos.</p>';
      }
    } catch(err){ 
      console.error(err); 
      listContainer.innerHTML='<p class="text-red-500 col-span-full">Error al cargar los participantes.</p>'; 
    }
  }
</script>



<script src="/js/curso.js"></script>
<script src="/js/curso-calificaciones.js"></script>
</body>
</html>