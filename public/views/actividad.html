<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Actividad</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <div id="header-container"></div>

  <main class="flex-grow flex items-center justify-center px-4 py-6">
    <div class="w-full max-w-3xl">

      <!-- Tarjeta de tarea -->
      <div id="actividad-root" class="bg-white rounded-xl shadow-md p-6 text-center">
        <h1 id="actividad-title" class="text-3xl font-bold text-green-700 mb-3">Cargando...</h1>
        <p id="actividad-description" class="text-gray-700 mb-3"></p>
        <p class="text-gray-500 mb-1">Fecha límite: <span id="actividad-due_at">—</span></p>
        <p class="text-gray-500 mb-3">Puntos: <span id="actividad-points">0</span></p>
        <p class="text-gray-500 mb-6">Estado: <span id="actividad-status">—</span></p>

        <div id="actividad-buttons" class="flex flex-wrap justify-center gap-2"></div>
      </div>

    </div>
  </main>

  <script src="/assets/js/tasks.js"></script>


  <script>
    // Cargar header
    fetch('/views/header.html')
      .then(res => res.text())
      .then(html => { document.getElementById('header-container').innerHTML = html });

    const holder = document.getElementById('actividad-root');
    const btnsHolder = document.getElementById('actividad-buttons');

    const params = new URLSearchParams(window.location.search);
    const cursoId = params.get("curso") || params.get("courseId") || params.get("curso_id");
    const tareaId = params.get("id") || params.get("tarea_id");

    function fmt(v) {
      if (!v) return "—";
      const t = new Date(v);
      return t.toLocaleString();
    }

    async function getPerfil() {
      const res = await fetch('/api/perfil', { credentials: 'include' });
      if (!res.ok) return null;
      return res.json();
    }

    async function getTarea() {
      const res = await fetch(`/api/tareas?action=listar&curso_id=${cursoId}`, { credentials: 'include' });
      if (!res.ok) return null;
      const tareas = await res.json();
      return tareas.find(t => t.id == tareaId);
    }

    async function initActividad() {
      if (!cursoId || !tareaId) {
        alert('Falta cursoId o tareaId');
        return;
      }

      try {
        const [perfil, tarea] = await Promise.all([getPerfil(), getTarea()]);
        if (!tarea) throw new Error("Tarea no encontrada");

        const esProfesor = perfil?.rol === 'profesor' || perfil?.rol === 'admin' || Number(perfil?.id) === Number(tarea.profesor_id);

        // Renderizar datos
        document.getElementById('actividad-title').textContent = tarea.title || "(Sin título)";
        document.getElementById('actividad-description').textContent = tarea.description || "";
        document.getElementById('actividad-due_at').textContent = fmt(tarea.due_at);
        document.getElementById('actividad-points').textContent = tarea.points ?? 0;
        document.getElementById('actividad-status').textContent = tarea.status || "pendiente";

        // Botones
        btnsHolder.innerHTML = '';

        if (esProfesor) {
          const editar = document.createElement('button');
          editar.textContent = "Editar tarea";
          editar.className = "px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700";
          editar.addEventListener('click', () => alert("Abrir modal de edición"));
          btnsHolder.appendChild(editar);
        } else {
          const entregar = document.createElement('button');
          entregar.textContent = "Entregar tarea";
          entregar.className = "px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700";
          entregar.addEventListener('click', () => alert("Abrir modal de entrega"));
          btnsHolder.appendChild(entregar);

          const ver = document.createElement('a');
          ver.textContent = "Ver última entrega";
          ver.href = `/api/entregas?action=descargar&tarea_id=${tareaId}`;
          ver.className = "px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 inline-block";
          btnsHolder.appendChild(ver);
        }

      } catch (err) {
        console.error(err);
        holder.innerHTML = `<p class="text-red-600">Error al cargar la actividad: ${err.message}</p>`;
      }
    }

    document.addEventListener("DOMContentLoaded", initActividad);
  </script>
</body>
</html>
