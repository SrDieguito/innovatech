<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Actividad</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <div id="header-container"></div>

  <main class="flex-grow px-4 py-8">
    <div class="max-w-5xl mx-auto space-y-6">

      <!-- Título y botones principales -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 id="actividad-title" class="text-3xl font-bold text-emerald-700">Cargando...</h1>
          <p id="actividad-description" class="text-gray-600 mt-1"></p>
        </div>
        <div id="actividad-buttons" class="flex flex-wrap gap-3"></div>
      </div>

      <!-- Detalles de la tarea -->
      <div class="bg-white rounded-2xl shadow-md p-6 space-y-4">
        <h2 class="text-lg font-semibold text-gray-800 border-b pb-2">Detalles de la tarea</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
          <p><span class="font-medium text-gray-700">Fecha de creación:</span> <span id="actividad-created_at" class="text-gray-600">—</span></p>
          <p><span class="font-medium text-gray-700">Fecha límite:</span> <span id="actividad-due_at" class="text-gray-600">—</span></p>
          <p><span class="font-medium text-gray-700">Estado:</span> <span id="actividad-status" class="px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-800">—</span></p>
          <p><span class="font-medium text-gray-700">Puntos:</span> <span id="actividad-points" class="text-gray-600">0</span></p>
          <p><span class="font-medium text-gray-700">Profesor:</span> <span id="actividad-profesor" class="text-gray-600">—</span></p>
          <p><span class="font-medium text-gray-700">Última entrega:</span> <span id="actividad-ultima-entrega" class="text-gray-600">—</span></p>
        </div>
      </div>

      <!-- Calificación -->
      <div class="bg-white rounded-2xl shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">Calificación</h2>
        <div id="actividad-calificacion" class="text-center text-gray-600">Aún no calificado</div>
      </div>

      <!-- Sección de comentarios -->
      <div class="bg-white rounded-2xl shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">Comentarios</h2>
        <div id="comentarios-list" class="space-y-4">
          <p class="text-gray-500 text-center">Sin comentarios aún</p>
        </div>

        <!-- Formulario de comentario -->
        <form id="formComentario" class="mt-4 flex gap-2">
          <input 
            type="text" 
            name="comentario" 
            placeholder="Escribe un comentario..." 
            required
            class="flex-1 px-3 py-2 border rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none"
          >
          <button 
            type="submit" 
            class="px-4 py-2 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition"
          >
            Enviar
          </button>
        </form>
      </div>
    </div>
  </main>

  <!-- Modal de entrega -->
  <dialog id="modalEntrega" class="rounded-2xl p-0 w-full max-w-md backdrop:bg-black/30">
    <form id="formEntrega" class="p-6 space-y-4" method="post" enctype="multipart/form-data">
      <h4 class="text-lg font-semibold">Entregar archivo</h4>
      <input type="hidden" name="tarea_id">
      <input type="hidden" name="curso_id">
      <div class="text-xs text-gray-600">Archivo actual: <span id="archivoActual">—</span></div>
      <label class="grid gap-1">
        <span class="text-sm text-gray-700">Archivo (máx 2 MB)</span>
        <input type="file" name="archivo" required
          class="px-3 py-2 rounded-xl border border-gray-200 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
        <span id="pesoArchivo" class="text-xs text-gray-500">—</span>
      </label>

      <!-- Previsualización de archivo -->
      <div id="previewContainer" class="mt-2">
        <p class="text-xs text-gray-500">Vista previa:</p>
        <div id="previewContent" class="border border-gray-200 rounded p-2 max-h-48 overflow-auto">—</div>
      </div>

      <div class="pt-2 flex items-center justify-end gap-2">
        <button type="button" id="btnCancelarEntrega"
          class="px-4 py-2 rounded-xl border border-gray-200 hover:bg-gray-50">Cancelar</button>
        <button type="submit"
          class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Subir</button>
      </div>
    </form>
  </dialog>

<script>
fetch('/views/header.html')
  .then(res => res.text())
  .then(html => {
    const container = document.getElementById('header-container');
    container.innerHTML = html;

    const scripts = container.querySelectorAll('script');
    scripts.forEach(oldScript => {
      const newScript = document.createElement('script');
      if (oldScript.src) newScript.src = oldScript.src;
      else newScript.textContent = oldScript.textContent;
      document.body.appendChild(newScript);
      oldScript.remove();
    });
  });

const params = new URLSearchParams(window.location.search);
const cursoId = params.get("curso") || params.get("courseId") || params.get("curso_id");
const tareaId = params.get("id") || params.get("tarea_id");

const holder = {
  title: document.getElementById('actividad-title'),
  desc: document.getElementById('actividad-description'),
  createdAt: document.getElementById('actividad-created_at'),
  dueAt: document.getElementById('actividad-due_at'),
  status: document.getElementById('actividad-status'),
  points: document.getElementById('actividad-points'),
  profesor: document.getElementById('actividad-profesor'),
  calificacion: document.getElementById('actividad-calificacion'),
  botones: document.getElementById('actividad-buttons'),
  comentarios: document.getElementById('comentarios-list'),
  ultimaEntrega: document.getElementById('actividad-ultima-entrega'),
  preview: document.getElementById('previewContent'),
  archivoActual: document.getElementById('archivoActual'),
};

function fmtDate(v){ return v ? new Date(v).toLocaleString() : "—"; }

async function getPerfil(){
  const res = await fetch('/api/perfil',{credentials:'include'});
  return res.ok?res.json():null;
}

async function getTarea(){
  const res = await fetch(`/api/tareas?action=listar&curso_id=${cursoId}`,{credentials:'include'});
  if(!res.ok) return null;
  const tareas = await res.json();
  return tareas.find(t=>t.id==tareaId);
}

async function getEntrega(){
  const res = await fetch(`/api/entregas?action=detalle&tarea_id=${tareaId}`,{credentials:'include'});
  return res.ok?await res.json():null;
}

async function getComentarios(){
  const res = await fetch(`/api/comentarios?tarea_id=${tareaId}`,{credentials:'include'});
  return res.ok?await res.json():[];
}

async function renderComentarios(){
  const comentarios = await getComentarios();
  holder.comentarios.innerHTML='';
  if(!comentarios.length){
    holder.comentarios.innerHTML=`<p class="text-gray-500 text-center">Sin comentarios aún</p>`;
    return;
  }
  comentarios.forEach(c=>{
    const div=document.createElement('div');
    div.className="flex items-start gap-3 border-b pb-2";
    div.innerHTML=`
      <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold">
        ${c.usuario[0].toUpperCase()}
      </div>
      <div class="flex-1">
        <p class="text-sm"><span class="font-medium">${c.usuario}</span> <span class="text-gray-500 text-xs">(${fmtDate(c.fecha)})</span></p>
        <p class="text-gray-700">${c.texto}</p>
      </div>`;
    holder.comentarios.appendChild(div);
  });
}

function openEntrega(tareaId){
  const dlg=document.getElementById('modalEntrega');
  const f=document.getElementById('formEntrega');
  f.reset();
  f.tarea_id.value=tareaId;
  if(f.curso_id) f.curso_id.value=cursoId;
  holder.preview.innerHTML='—';
  holder.archivoActual.textContent='—';
  getEntrega().then(e=>{
    if(!e) return;
    if(e.archivo_nombre) holder.archivoActual.textContent=e.archivo_nombre;
    holder.ultimaEntrega.textContent=e.archivo_nombre||'—';
    if(e.archivo_url){
      const ext=e.archivo_nombre.split('.').pop().toLowerCase();
      if(["png","jpg","jpeg","gif"].includes(ext)){
        holder.preview.innerHTML=`<img src="${e.archivo_url}" class="max-h-48 mx-auto rounded">`;
      }else if(ext==="pdf"){
        holder.preview.innerHTML=`<iframe src="${e.archivo_url}" class="w-full h-48"></iframe>`;
      }else{
        holder.preview.innerHTML=`<a href="${e.archivo_url}" target="_blank" class="text-blue-600 underline">Abrir archivo</a>`;
      }
    }
  });
  dlg.showModal();
}

document.getElementById('formEntrega').addEventListener('submit', async e => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const res = await fetch('/api/entregas?action=subir', {
    method: 'POST',
    body: formData,
    credentials: 'include'
  });
  if (res.ok) {
    const data = await res.json();
holder.archivoActual.textContent = data?.entrega?.archivo_nombre || formData.get('archivo')?.name || '—';
holder.ultimaEntrega.textContent = data?.entrega?.archivo_nombre || formData.get('archivo')?.name || '—';
updateStatusVisual(holder.status, data?.entrega?.estado || 'entregado');

  } else {
    const data = await res.json().catch(() => ({ error: 'Error desconocido' }));
    alert('Error al subir el archivo: ' + (data.error || 'Desconocido'));
  }
});

function updateStatusVisual(statusEl, estado) {
  statusEl.textContent = estado || 'pendiente';

  // Limpiar clases de color previas
  statusEl.className = "px-2 py-0.5 rounded-full text-xs";

  switch ((estado||'').toLowerCase()) {
    case 'pendiente':
      statusEl.classList.add('bg-red-100','text-red-700');
      break;
    case 'entregado':
      statusEl.classList.add('bg-orange-100','text-orange-700');
      break;
    case 'calificado':
      statusEl.classList.add('bg-green-100','text-green-700');
      break;
    case 'expirado':
      statusEl.classList.add('bg-red-100','text-red-700');
      break;
    default:
      statusEl.classList.add('bg-gray-100','text-gray-800');
  }
}


async function initActividad(){
  if(!cursoId||!tareaId){alert('Falta cursoId o tareaId');return;}
  try{
    const [perfil,tarea]=await Promise.all([getPerfil(),getTarea()]);
    if(!tarea) throw new Error("Tarea no encontrada");

    const esProfesor=perfil?.rol==='profesor'||perfil?.rol==='admin'||Number(perfil?.id)===Number(tarea.profesor_id);

    holder.title.textContent=tarea.title||"(Sin título)";
    holder.desc.textContent=tarea.description||"";
    holder.createdAt.textContent=fmtDate(tarea.created_at);
    holder.dueAt.textContent=fmtDate(tarea.due_at);
    const entrega = await getEntrega();
updateStatusVisual(holder.status, entrega?.entrega?.estado || 'pendiente');
holder.ultimaEntrega.textContent = entrega?.entrega?.archivo_nombre || '—';
holder.archivoActual.textContent = entrega?.entrega?.archivo_nombre || '—';

    holder.points.textContent=tarea.points??0;
    holder.profesor.textContent=tarea.profesor_nombre||"—";
    holder.calificacion.innerHTML=tarea.calificacion?`<span class="text-2xl font-bold text-emerald-600">${tarea.calificacion}</span> / 10`:`<span class="text-gray-500">Aún no calificado</span>`;

    holder.botones.innerHTML='';
    if(esProfesor){
      const editar=document.createElement('button');
      editar.textContent="Editar tarea";
      editar.className="px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition";
      editar.addEventListener('click',()=>alert("Abrir modal de edición"));

      const eliminar=document.createElement('button');
      eliminar.textContent="Eliminar tarea";
      eliminar.className="px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 transition";
      eliminar.addEventListener('click',()=>{if(confirm("¿Seguro que quieres eliminar esta tarea?"))alert("Tarea eliminada (demo)");});

      holder.botones.appendChild(editar);
      holder.botones.appendChild(eliminar);
    }else{
      const entregar=document.createElement('button');
      entregar.textContent="Entregar";
      entregar.className="px-4 py-2 bg-emerald-600 text-white rounded-xl hover:bg-green-700 transition";
      entregar.addEventListener('click',()=>openEntrega(tareaId));

      const ver=document.createElement('a');
      ver.textContent="Ver última entrega";
      ver.href=`/api/entregas?action=descargar&tarea_id=${tareaId}`;
      ver.className="px-4 py-2 border border-gray-300 rounded-xl hover:bg-gray-50 transition";

      holder.botones.appendChild(entregar);
      holder.botones.appendChild(ver);
    }

    await renderComentarios();

    document.getElementById('formComentario').addEventListener('submit',async e=>{
      e.preventDefault();
      const texto=e.target.comentario.value.trim();
      if(!texto) return;
      await fetch(`/api/comentarios?tarea_id=${tareaId}`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({texto})
      });
      e.target.comentario.value='';
      await renderComentarios();
    });

  }catch(err){
    console.error(err);
    holder.title.textContent="Error al cargar";
    holder.desc.textContent=err.message;
  }
}

// ----------------------------
// Auto actualizar estado al subir entrega
// ----------------------------
document.addEventListener("DOMContentLoaded",initActividad);
</script>

</body>
</html>
